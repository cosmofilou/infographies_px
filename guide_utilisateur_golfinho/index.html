Public Sub LancerNettoyageFichierSYM()
    ' Macro principale qui orchestre le nettoyage du fichier SYM.
    ' VERSION ROBUSTE AVEC LECTURE LIGNE PAR LIGNE
    
    Dim folderPath As String, sourcePath As String, outputPath As String
    Dim FSO As Object, sourceFile As Object, outputFile As Object
    Dim summaryReport As String
    
    On Error GoTo ErrorHandler
    
    ' --- Étape 1 : Confirmation utilisateur ---
    
    Dim userResponse As VbMsgBoxResult
    Dim promptMsg As String
    
    promptMsg = "Cette opération va nettoyer le fichier des déposes RFC (SYM)." & vbNewLine & vbNewLine & _
                "Veuillez confirmer que le fichier suivant est bien présent :" & vbNewLine & _
                "- Fichier : Fichier_SYM_original.txt" & vbNewLine & _
                "- Emplacement : \Données à traiter\" & vbNewLine & vbNewLine & _
                "Voulez-vous continuer ?"
                
    userResponse = MsgBox(promptMsg, vbYesNo + vbQuestion, "Golfinho - Confirmation")
    If userResponse = vbNo Then
        MsgBox "Opération annulée.", vbInformation
        Exit Sub
    End If
    
    Application.ScreenUpdating = False
    Application.StatusBar = "Traitement du fichier SYM en cours..."
    
    ' --- Étape 2 : Lecture et préparation des fichiers ---
    
    folderPath = ThisWorkbook.Path & "\Données à traiter\"
    sourcePath = folderPath & "Fichier_SYM_original.txt"
    
    If Dir(sourcePath) = "" Then
        MsgBox "Le fichier 'Fichier_SYM_original.txt' est introuvable dans le dossier 'Données à traiter'.", vbCritical, "Golfinho - Erreur"
        GoTo Cleanup
    End If
    
    Set FSO = CreateObject("Scripting.FileSystemObject")
    
    If FSO.GetFile(sourcePath).Size = 0 Then
        MsgBox "Le fichier 'Fichier_SYM_original.txt' est vide. Traitement annulé.", vbExclamation, "Golfinho - Fichier Vide"
        GoTo Cleanup
    End If
    
    ' --- Étape 3 : Traitement des données ligne par ligne ---
    
    Dim dateReleve As String
    Dim linesDeleted As Long, linesTransformed As Long
    Dim previousLineWasDeleted As Boolean
    Dim currentLine As String, parts As Variant
    
    ' On ouvre le fichier une première fois juste pour lire la date
    Set sourceFile = FSO.OpenTextFile(sourcePath, 1) ' ForReading
    If Not sourceFile.AtEndOfStream Then
        parts = Split(sourceFile.ReadLine, ";")
        If UBound(parts) >= 3 Then
            dateReleve = Trim(parts(3))
            If Not (Len(dateReleve) = 8 And IsNumeric(dateReleve)) Then dateReleve = "SANS_DATE"
        Else
            dateReleve = "SANS_DATE"
        End If
    Else
        dateReleve = "SANS_DATE"
    End If
    sourceFile.Close
    
    outputPath = folderPath & "Fichier_SYM_original_modifie_" & dateReleve & ".txt"
    
    ' On ouvre les fichiers pour le traitement principal
    Set sourceFile = FSO.OpenTextFile(sourcePath, 1)
    Set outputFile = FSO.CreateTextFile(outputPath, True) ' ForWriting, Overwrite
    
    previousLineWasDeleted = False
    Do While Not sourceFile.AtEndOfStream
        currentLine = sourceFile.ReadLine
        
        If Trim(currentLine) <> "" Then
            parts = Split(currentLine, ";")
            
            Dim processedLine As String
            processedLine = currentLine
            
            If UBound(parts) >= 5 And Left(currentLine, 1) = "2" Then
                If Trim(parts(5)) = "99999999" Then
                    ' C'est une ligne fictive, on la supprime (en ne l'écrivant pas)
                    linesDeleted = linesDeleted + 1
                    previousLineWasDeleted = True
                Else
                    previousLineWasDeleted = False
                End If
            ElseIf Left(currentLine, 1) = "4" And previousLineWasDeleted Then
                ' C'est une ligne '4' qui suit une suppression, on la transforme
                processedLine = "2" & Mid(currentLine, 2)
                linesTransformed = linesTransformed + 1
                previousLineWasDeleted = False
            Else
                previousLineWasDeleted = False
            End If
            
            ' On écrit la ligne si elle n'a pas été supprimée
            If Not (Left(currentLine, 1) = "2" And UBound(parts) >= 5 And Trim(parts(5)) = "99999999") Then
                outputFile.WriteLine processedLine
            End If
        End If
    Loop
    
    sourceFile.Close
    outputFile.Close
    
    ' --- Étape 4 : Rapport final ---
    
    summaryReport = "Traitement du fichier SYM terminé avec succès !" & vbNewLine & vbNewLine & _
                    "   - Lignes de répartiteurs fictifs supprimées : " & linesDeleted & vbNewLine & _
                    "   - Lignes '4' transformées en '2' : " & linesTransformed & vbNewLine & vbNewLine & _
                    "Le fichier modifié a été enregistré sous :" & vbNewLine & outputPath
                    
    MsgBox summaryReport, vbInformation, "Golfinho - Traitement Terminé"
    
Cleanup:
    Application.StatusBar = False
    Application.ScreenUpdating = True
    On Error Resume Next ' Ignore les erreurs pendant le nettoyage
    If Not sourceFile Is Nothing Then sourceFile.Close
    If Not outputFile Is Nothing Then outputFile.Close
    Set FSO = Nothing
    Exit Sub
    
ErrorHandler:
    MsgBox "Une erreur critique est survenue : " & Err.Description, vbCritical, "Golfinho - Erreur"
    GoTo Cleanup
End Sub
